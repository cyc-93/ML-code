# -*- coding: utf-8 -*-
"""
Batch Raster Post-processing Script: Multiply by a Constant

This script reads the prediction raster TIF files (e.g., 'WHEA_ssp126_predicted_yield.tif')
generated by the 'batch_crop_yield_prediction.py' script.
It multiplies all valid pixel values by a fixed constant (0.542) and saves the result 
as a new TIF file (e.g., 'WHEA_ssp126_multiplied_0.542.tif').
"""

import os
import sys
import rasterio
import numpy as np

# --- 1. Configuration ---

# The constant multiplier
MULTIPLIER = 0.542

# (!!!) The following configurations must match 'batch_crop_yield_prediction.py'
# to correctly locate the generated TIF files.

# 4.1 Crop Configuration (4 types)
CROP_CONFIGS = [
    {"name": "WHEA", "type_id": 2, "yield_raster": "spam2020_V2r0_global_Y_WHEA_A.tif"},
    {"name": "MAIZ", "type_id": 3, "yield_raster": "spam2020_V2r0_global_Y_MAIZ_A.tif"},
    {"name": "SOYB", "type_id": 4, "yield_raster": "spam2020_V2r0_global_Y_SOYB_A.tif"},
    {"name": "RICE", "type_id": 1, "yield_raster": "spam2020_V2r0_global_Y_RICE_A.tif"}
]

# 4.2 Climate Scenario Configuration (4 types)
SSP_CONFIGS = [
    {"name": "ssp126", "raster_file": "UKESM1-0-LL_ssp126_2081-2100_678mean.tif"},
    {"name": "ssp245", "raster_file": "UKESM1-0-LL_ssp245_2081-2100_678mean.tif"},
    {"name": "ssp370", "raster_file": "UKESM1-0-LL_ssp370_2081-2100_678mean.tif"},
    {"name": "ssp585", "raster_file": "UKESM1-0-LL_ssp585_2081-2100_678mean.tif"}
]

# --- 2. Main Processing Function ---
if __name__ == '__main__':
    print(f"====== Starting Batch Processing: Multiplying Raster Values by {MULTIPLIER} ======")

    total_files = len(CROP_CONFIGS) * len(SSP_CONFIGS)
    processed_count = 0
    fail_count = 0

    for crop in CROP_CONFIGS:
        for ssp in SSP_CONFIGS:

            run_name = f"{crop['name']}_{ssp['name']}"

            # Define input and output filenames
            # Input must match the output format from the previous pipeline script
            input_file = f"{run_name}_predicted_yield.tif"
            output_file = f"{run_name}_multiplied_{MULTIPLIER}.tif"

            current_job_index = processed_count + fail_count + 1
            print(f"\n======= Processing ({current_job_index}/{total_files}): {input_file} =======")

            # 2.1 Check if input file exists
            if not os.path.exists(input_file):
                print(f"  [Warning] File not found: {input_file}. Skipping.")
                print(f"  Please ensure you have successfully ran 'batch_crop_yield_prediction.py'.")
                fail_count += 1
                continue

            try:
                # 2.2 Open the raster file
                with rasterio.open(input_file) as src:
                    profile = src.profile
                    nodata = src.nodata
                    data = src.read(1)

                    # 2.3 Create a mask to select only valid pixels (not nodata)
                    # This prevents multiplying nodata values (e.g., -9999 * 0.542)
                    if nodata is not None:
                        mask = data != nodata
                    else:
                        # If no nodata defined, process all pixels
                        mask = np.ones_like(data, dtype=bool)

                    valid_pixel_count = np.count_nonzero(mask)
                    print(f"  [Info] Multiplying {valid_pixel_count} / {data.size} valid pixels by {MULTIPLIER}...")

                    # 2.4 Perform multiplication only on valid pixels
                    # Note: Modifying the data array in place
                    data[mask] = data[mask] * MULTIPLIER

                    # 2.5 Update profile to ensure data type remains float
                    profile.update(dtype=rasterio.float32)

                    # 2.6 Write modified data to new TIF file
                    with rasterio.open(output_file, 'w', **profile) as dst:
                        dst.write(data, 1)

                    print(f"  [Success] Saved to: {output_file}")
                    processed_count += 1

            except Exception as e:
                print(f"  [!!! Error !!!] Failed processing {input_file}: {e}")
                fail_count += 1

    # --- 3. Final Summary ---
    print("\n\n========================================")
    print(f"====== âœ… Multiplication Process Complete ======")
    print(f"  Success: {processed_count} / {total_files}")
    print(f"  Failed/Skipped: {fail_count} / {total_files}")
    print("========================================")